<source>
  @type forward
  @id input_forward
  port 24224
  bind 0.0.0.0
</source>

<filter source.docker.**>
  @type record_transformer
  <record>
    service ${record["container_name"]}  
    label_container_name ${record["container_name"]}
    label_container_image ${record["container_image"]}
    label_host ${record["host"]}
    label_service ${record["service"]}
  </record>
</filter>

<match source.docker.**>
  @type copy
  <store>
    @type loki
    @id output_loki_docker
    url "http://loki:3100" 
    flush_interval 3s
    line_format json
    remove_keys time,stream,container_id,label_container_name,label_container_image,label_host,label_service 
    label_keys label_container_name,label_container_image,label_host,label_service  
    <label>
      job docker-logs 
      source docker
      keys label_keys
      container_name label_container_name
      container_image label_container_image
      host label_host
      service label_service
    </label>
    <buffer>
      flush_interval 3s
      retry_type exponential_backoff
      retry_wait 1s
      retry_max_interval 30s
      retry_forever true
    </buffer>
  </store>
  <store>
    @type stdout
    @id output_stdout_debug
    <format>
      @type json  # Для отладки
    </format>
  </store>
</match>

# Обработка остальных логов
<match **>
  @type stdout
</match>

# Фикс для логов Fluentd
<label @FLUENT_LOG>
  <match fluent.**>
    @type stdout
  </match>
</label>