<source>
  @type forward
  @id input_forward
  port 24224
  bind 0.0.0.0
</source>

<filter **>
  @type record_transformer
  @id   add_host_if_missing
  enable_ruby true
  <record>
    host ${record["host"] || "unknown_host_from_fluentd"}
    container_name ${record["container_name"] || "unknown_container"}
    stream ${record["stream"] || "unknown_stream"}
  </record>
</filter>

<match **>
  @type loki
  @id output_loki
  @log_level info
  enable_ruby true
  endpoint_url "http://#{ENV['SERVER_LOKI_NAME']}:#{ENV['PORT_LOKI']}/loki/api/v1/push"
  include_thread_label true
  extra_labels {"env": "prod"}
  <label>
    host ${record["host"] || 'unknown_host_from_fluentd'}
    container_name ${record["container_name"] || 'unknown_container'}
    stream ${record["stream"] || 'unknown_stream'}
    fluentd_worker "#{worker_id}"
  </label>
  line_format json
  remove_keys host,container_name,stream
  <buffer>
    @type file
    path /fluentd/log/buffer/loki
    flush_interval 10s
    chunk_limit_size 2M
    queue_limit_length 8
    retry_max_interval 30
    retry_forever true
  </buffer>
</match>

<label @FLUENT_LOG>
  <match fluent.*>
    @type stdout
    @id output_fluent_log
  </match>
</label>