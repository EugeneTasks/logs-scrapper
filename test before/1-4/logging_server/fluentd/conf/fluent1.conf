<source>
  @type forward
  @id input_forward
  port 24224
  bind 0.0.0.0
</source>

<filter source.docker.**>
  @type record_transformer
  @id   enrich_docker_logs
  enable_ruby true
  <record>
    host ${record["host"] || "unknown_host"}
    container_name ${record["docker"] ? record["docker"]["container_name"].gsub("/","") : (record["container_name"] || "unknown_container")}
    stream ${record["stream"] || "unknown_stream"}
  </record>
</filter>

<match source.docker.**>
  @type grafana_loki
  @id output_loki
  @log_level info

  url "http://#{ENV['SERVER_LOKI_NAME']}:#{ENV['PORT_LOKI']}/loki/api/v1/push"
  
  <label>
    env "prod"
    fluentd_worker "#{worker_id}"
  </label>

  <format>
    @type json
    labels {"host": "host", "container_name": "container_name", "stream": "stream"}
  </format>

  <buffer>
    @type memory
    flush_interval 5s
    chunk_limit_size 2M
    queue_limit_length 32
    retry_max_interval 30
    retry_forever false
    retry_max_times 5 
    overflow_action drop_oldest_chunk
  </buffer>
</match>

<label @FLUENT_LOG>
  <match fluent.**>
    @type stdout
    @id output_fluent_log
  </match>
</label>